<!-- 2.	Движение заряженных частиц в электростатическом поле -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Моделирование №2</title>
    <meta charset='utf-8' />

    <style>
        canvas {
            border-style: solid;
        }
    </style>

    <script src="Particle.js"></script>
    <script type="text/javascript">
        let canvas, ctx;
        let raf_id;

        // Note: ось y направлена вниз в canvas
        let init_coordinate_x, init_coordinate_y;
        const SPACER = 20;

        let array_of_objects = [];

        function init() {
            // Инициализация canvas
            canvas = document.getElementById("canvas_id");
            ctx    = canvas.getContext('2d');
            init_coordinate_x = SPACER;
            init_coordinate_y = canvas.height - SPACER;
            raf_id = window.requestAnimationFrame(redraw_window_function);

            document.getElementById("input_init_x").max = canvas.width;
            document.getElementById("input_init_x").value = 0;
            document.getElementById("input_init_y").max = canvas.height;
            document.getElementById("input_init_y").value = canvas.height / 2;
        }

        // function draw_axis() {
        //     // Отрисовка прямых линий
        //     ctx.beginPath();
        //     ctx.moveTo(init_coordinate_x, init_coordinate_y);
        //     ctx.lineTo(canvas.width - SPACER, init_coordinate_y);
        //     ctx.moveTo(init_coordinate_x, init_coordinate_y);
        //     ctx.lineTo(init_coordinate_x, SPACER);
        //     ctx.stroke();
        // }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        function delete_particle_from_array(idx) {
            array_of_objects = array_of_objects.filter(function (value) {
                return value.IDX !== idx;
            });
        }

        function clear_all() {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }

        // Считаем, что поле начинается с середины экрана (с середины ширины)
        function draw_area_electric_field() {
            ctx.save();
            ctx.fillStyle = "rgba(125,255,125,0.5)";
            ctx.fillRect(canvas.width / 2, 0, canvas.width / 2, canvas.height);
            ctx.restore();
        }

        function redraw_all_objects() {
            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].draw();
            }
        }

        // ToDO: debug
        // ToDO: поле направлено вертикально
        function create_particle_and_animate_console(vel = 1, x_dir = 1, y_dir = 0, init_x = 0, init_y = canvas.height / 2) {
            // ToDO:
            let q = 1;

            let p = new Particle(init_x, init_y, vel, q, 1, 0, 1);

            // ToDO: добавить массу
            p.Velocity_Vector = (new Vector(x_dir, y_dir)).normalize();
            array_of_objects.push(p);
        }

        function create_particle() {
            let p = new Particle(
                Number(document.getElementById("input_init_x").value),
                Number(document.getElementById("input_init_y").value),
                Number(document.getElementById("input_init_velocity").value),
                Number(document.getElementById("input_init_q").value),
                Number(document.getElementById("input_init_x_dir").value),
                Number(document.getElementById("input_init_y_dir").value),
                Number(document.getElementById("input_init_m").value)
            );

            p.Velocity_Vector.normalize();
            array_of_objects.push(p);

        }
        
        function calculate_all_next_step() {
            let time = Number(document.getElementById("input_time_multiplier").value);
            let e_field = Number(document.getElementById("input_init_e_field").value);
            let vector_e_dir_down = document.getElementById("input_init_e_field_dir").checked;

            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].next_step(e_field, vector_e_dir_down, time);
            }

            let items_to_delete = [];
            for (let i = 0; i < array_of_objects.length; i++) {
                if (!array_of_objects[i].in_view())
                    items_to_delete.push(array_of_objects[i].IDX);
            }

            for (let i = 0; i < items_to_delete.length; i++) {
                delete_particle_from_array(items_to_delete[i]);
            }
        }
        
        function redraw_window_function() {
            calculate_all_next_step();
            clear_all();
            draw_area_electric_field();
            redraw_all_objects();
            window.requestAnimationFrame(redraw_window_function);
        }

        function reset_to_defaults() {
            document.getElementById("input_init_x").value = 0;
            document.getElementById("input_init_y").value = canvas.height / 2;
            document.getElementById("input_init_velocity").value = 1;
            document.getElementById("input_init_x_dir").value = 1;
            document.getElementById("input_init_y_dir").value = 0;
            document.getElementById("input_init_e_field").value = 1;
            document.getElementById("input_init_e_field_dir").checked = true;
            document.getElementById("input_time_multiplier").value = 1;
            document.getElementById("input_init_q").value = 0;
            document.getElementById("input_init_m").value = 1;
        }

    </script>
</head>

<body onload="init()">
    <canvas height='200' width='800' id='canvas_id'>Обновите браузер</canvas>
    <br>
    <button onclick="create_particle()">Добавить объект</button>
    <!-- ToDO: debug -->
    <button onclick="create_particle_and_animate_console(4, 1, -0.2)">Test</button>
    <br>
    <br>

    <table>
        <tr>
            <td>
                <label for="input_init_x">
                    Начальная координата X:
                </label>
            </td>
            <td>
                <!-- Set maximum is in init() -->
                <input type="number" id="input_init_x" min="0">
            </td>
        </tr>
        <tr>
            <td>
                <!-- Set maximum is in init() -->
                <label for="input_init_y">
                    Начальная координата Y:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_y" min="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_q">
                    Коэффициент заряда q:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_q" value="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_m">
                    Коэффициент массы m:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_m" value="1" min="0.001">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_velocity">
                    Начальная скорость V<sub>0</sub>:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_velocity" min="0" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_x_dir">
                    Координата X вектора направления скорости:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_x_dir" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_y_dir">
                    Координата Y вектора направления скорости:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_y_dir" value="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_e_field">
                    Напряженность поля:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_e_field" min="1" max="100" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_e_field_dir">
                    Поле направлено вниз?
                </label>
            </td>
            <td>
                <input type="checkbox" id="input_init_e_field_dir" checked>
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_time_multiplier">
                    Коэффициент ускорения времени:
                </label>
            </td>
            <td>
                <input type="number" id="input_time_multiplier" min="0" max="5" step="0.01" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <button onclick="reset_to_defaults()">Сбросить</button>
            </td>
        </tr>
    </table>

    <!--
    <div>
        <label>
            Текст:<input type="range">
        </label>
    </div>
    -->

</body>
</html>

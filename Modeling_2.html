<!-- 2.	Движение заряженных частиц в электростатическом поле -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Моделирование №2</title>
    <meta charset='utf-8' />

    <link rel="stylesheet" type="text/css" href="Styles.css">

    <script src="Particle.js"></script>
    <script type="text/javascript">
        let canvas, ctx;
        let raf_id;
        let selected_element = -1;

        // Note: ось y направлена вниз в canvas
        let init_coordinate_x, init_coordinate_y;
        const SPACER = 20;

        let array_of_objects = [];

        // ToDO: changeable field width
        let field_p1;
        let field_p2;

        function init() {
            // Инициализация canvas
            canvas = document.getElementById("canvas_id");
            ctx    = canvas.getContext('2d');
            init_coordinate_x = SPACER;
            init_coordinate_y = SPACER;
            raf_id = window.requestAnimationFrame(redraw_window_function);

            document.getElementById("input_init_x").max = canvas.width;
            document.getElementById("input_init_x").value = canvas.width / 4;
            document.getElementById("input_init_y").max = canvas.height;
            document.getElementById("input_init_y").value = canvas.height / 2;

            field_p1 = new Point(canvas.width / 2, 0);
            field_p2 = new Point(canvas.width, canvas.height);

            // Добавление ограничений в текстовые поля
            document.getElementById("input_init_x_label").innerText += " [0 .. " + canvas.width + "]";
            document.getElementById("input_init_y_label").innerText += " [0 .. " + canvas.height + "]";
        }

        function draw_axis() {
            ctx.save();

            // Угол под которым будут направлены линии стрелок
            let delta_a = 10;
            let delta_b = 30;


            // Отрисовка прямых линий
            ctx.beginPath();

            // Ось X
            ctx.moveTo(init_coordinate_x, init_coordinate_y);
            ctx.lineTo(canvas.width - SPACER, init_coordinate_y);

            // Стрелки
            ctx.lineTo(canvas.width - SPACER - delta_b, init_coordinate_y - delta_a);
            ctx.moveTo(canvas.width - SPACER, init_coordinate_y);
            ctx.lineTo(canvas.width - SPACER - delta_b, init_coordinate_y + delta_a);
            ctx.moveTo(canvas.width - SPACER, init_coordinate_y);

            // Название
            ctx.save();
            ctx.font = '20px serif';
            ctx.fillText("X", canvas.width - SPACER, init_coordinate_y + 20);
            ctx.restore();

            // Ось Y
            ctx.moveTo(init_coordinate_x, init_coordinate_y);
            ctx.lineTo(init_coordinate_x, canvas.height - SPACER);

            // Стрелки
            ctx.lineTo(init_coordinate_x + delta_a, canvas.height - SPACER - delta_b);
            ctx.moveTo(init_coordinate_x, canvas.height - SPACER);
            ctx.lineTo(init_coordinate_x - delta_a, canvas.height - SPACER - delta_b);
            ctx.moveTo(init_coordinate_x, canvas.height - SPACER);

            // Название
            ctx.save();
            ctx.font = '20px serif';
            ctx.fillText("Y", SPACER + 10, canvas.height - SPACER + 10);
            ctx.restore();

            ctx.stroke();

            ctx.restore();
        }

        function delete_particle_from_array(idx) {
            array_of_objects = array_of_objects.filter(function (value) {
                return value.IDX !== idx;
            });
        }

        function clear_all() {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }

        // Считаем, что поле начинается с середины экрана (с середины ширины)
        function draw_area_electric_field() {
            ctx.save();
            ctx.fillStyle = "rgba(125,255,125,0.5)";
            ctx.fillRect(canvas.width / 2, 0, canvas.width / 2, canvas.height);
            ctx.restore();
        }

        function redraw_all_objects() {
            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].draw();
            }
        }

        // ToDO: debug
        // ToDO: поле направлено вертикально
        function create_particle_and_animate_console(vel = 1, x_dir = 1, y_dir = 0, init_x = 0, init_y = canvas.height / 2) {
            // ToDO:
            let q = 1;

            let p = new Particle(init_x, init_y, vel, q, 1, 0, 1);

            // ToDO: добавить массу
            p.Velocity_Vector = (new Vector(x_dir, y_dir)).normalize();
            array_of_objects.push(p);
        }

        function create_particle() {
            let p = new Particle(
                Number(document.getElementById("input_init_x").value),
                Number(document.getElementById("input_init_y").value),
                Number(document.getElementById("input_init_velocity").value),
                Number(document.getElementById("input_init_q").value),
                Number(document.getElementById("input_init_x_dir").value),
                Number(document.getElementById("input_init_y_dir").value),
                Number(document.getElementById("input_init_m").value)
            );

            p.Velocity_Vector.normalize();
            array_of_objects.push(p);
            if (selected_element === -1) selected_element = p.IDX;
        }
        
        function calculate_all_next_step() {
            let time = Number(document.getElementById("input_time_multiplier").value) / 60;
            let e_field =
                (document.getElementById("input_init_e_is_on").checked) ?
                Number(document.getElementById("input_init_e_field").value) : 0;

            let vector_e_dir_down = document.getElementById("input_init_e_field_dir").checked;

            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].next_step(e_field, vector_e_dir_down, time);
            }

            let items_to_delete = [];
            for (let i = 0; i < array_of_objects.length; i++) {
                if (!array_of_objects[i].in_view())
                    items_to_delete.push(array_of_objects[i].IDX);
            }

            for (let i = 0; i < items_to_delete.length; i++) {
                if (items_to_delete[i] === selected_element)
                    selected_element = -1;
                delete_particle_from_array(items_to_delete[i]);
            }
        }

        function canvas_arrow(context, fromx, fromy, tox, toy) {
            let headlen = 10; // length of head in pixels
            let dx = tox - fromx;
            let dy = toy - fromy;
            let angle = Math.atan2(dy, dx);
            context.moveTo(fromx, fromy);
            context.lineTo(tox, toy);
            context.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            context.moveTo(tox, toy);
            context.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
        }
        
        function draw_init_state() {
            ctx.save();

            ctx.beginPath();
            ctx.moveTo(parseInt(document.getElementById("input_init_x").value), parseInt(document.getElementById("input_init_y").value));

            let tmp = new Particle(parseInt(document.getElementById("input_init_x").value), parseInt(document.getElementById("input_init_y").value),
                parseInt(document.getElementById("input_init_velocity").value), 0,
                parseInt(document.getElementById("input_init_x_dir").value),
                parseInt(document.getElementById("input_init_y_dir").value), 0, false);

            if (parseInt(document.getElementById("input_init_velocity").value) !== 0) {
                tmp.draw_arrow_velocity();
            }

            ctx.closePath();

            ctx.beginPath();
            ctx.arc(
                parseInt(document.getElementById("input_init_x").value),
                parseInt(document.getElementById("input_init_y").value),
                Particle.R_,
                0, 2 * Math.PI, true
            );
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.stroke();

            ctx.restore();
        }

        function draw_field_arrows_and_name() {
            ctx.save();

            ctx.strokeStyle = "rgba(0, 0, 0, 0.5)";

            // Нарисуем только 4 прямые
            let k = 4;
            let curr_x = canvas.width / 2;
            let delta = (canvas.width / 2) / (k + 1);

            // Будем использовать SPACER * 2 для y

            for (let i = 1; i <= k; ++i) {
                ctx.beginPath();
                canvas_arrow(ctx, curr_x + i * delta,
                    document.getElementById("input_init_e_field_dir").checked ? SPACER * 2 : canvas.height - SPACER * 2,
                    curr_x + i * delta,
                    document.getElementById("input_init_e_field_dir").checked ? canvas.height - SPACER * 2 : SPACER * 2
                );
                ctx.stroke();
            }

            ctx.save();
            ctx.font = '20px serif';
            ctx.fillText("E = const", canvas.width / 2 + 5, canvas.height - 5);
            ctx.restore();
            ctx.restore();
        }

        function find_selected_particle(idx) {
            for (let i = 0; i < array_of_objects.length; ++i) {
                if (array_of_objects[i].IDX === idx)
                    return array_of_objects[i];
            }
        }

        function update_selected_point_data() {
            if (selected_element === -1) {
                document.getElementById("output_x").innerText = "[X]";
                document.getElementById("output_y").innerText = "[Y]";
                document.getElementById("output_v").innerText = "[V]";
                document.getElementById("output_a").innerText = "[A]";
                document.getElementById("output_q").innerText = "[Q]";
                document.getElementById("output_m").innerText = "[M]";
                document.getElementById("output_f").innerText = "[F]";

                document.getElementById("output_v_x").innerHTML = "[V<sub>X</sub>]";
                document.getElementById("output_v_y").innerHTML = "[V<sub>Y</sub>]";

                document.getElementById("output_a_x").innerHTML = "[A<sub>X</sub>]";
                document.getElementById("output_a_y").innerHTML = "[A<sub>Y</sub>]";

                document.getElementById("output_f_x").innerHTML = "[F<sub>X</sub>]";
                document.getElementById("output_f_y").innerHTML = "[F<sub>Y</sub>]";
            } else {
                let selected_particle = find_selected_particle(selected_element);
                if (selected_particle !== undefined) {
                    document.getElementById("output_x").innerText = (selected_particle.X).toFixed(5);
                    document.getElementById("output_y").innerText = (selected_particle.Y).toFixed(5);
                    document.getElementById("output_v").innerText = (selected_particle.Velocity).toFixed(5);

                    let vector_e_dir_down = true;
                    let e_field = 0;
                    let vector_force = new Vector(0, 0);
                    let vector_acceleration = new Vector(0, 0);
                    let acceleration_module = 0;

                    if (selected_particle.in_electric_field() && document.getElementById("input_init_e_is_on").checked) {
                        vector_e_dir_down = document.getElementById("input_init_e_field_dir").checked;
                        e_field = document.getElementById("input_init_e_field").value;
                        vector_force = (new Vector(0, vector_e_dir_down ? 1 : -1)).multiply(e_field).multiply(selected_particle.Q);
                        vector_acceleration = Vector.divide(vector_force, selected_particle.Mass);
                        acceleration_module = vector_acceleration.length();
                    }

                    document.getElementById("output_a").innerText = acceleration_module.toFixed(5);
                    document.getElementById("output_q").innerText = (selected_particle.Q).toFixed(5);
                    document.getElementById("output_m").innerText = (selected_particle.Mass).toFixed(5);
                    document.getElementById("output_f").innerText = (vector_force.length()).toFixed(5);

                    // Проекции
                    document.getElementById("output_v_x").innerText = (selected_particle.Velocity * selected_particle.Velocity_Vector.x).toFixed(5);
                    document.getElementById("output_v_y").innerText = (selected_particle.Velocity * selected_particle.Velocity_Vector.y).toFixed(5);

                    document.getElementById("output_a_x").innerText = vector_acceleration.x;
                    document.getElementById("output_a_y").innerText = vector_acceleration.y;

                    document.getElementById("output_f_x").innerText = vector_force.x;
                    document.getElementById("output_f_y").innerText = vector_force.y;
                }
            }
        }
        
        function redraw_window_function() {
            calculate_all_next_step();
            update_selected_point_data();
            clear_all();
            if (document.getElementById("input_init_e_is_on").checked) draw_area_electric_field();
            draw_axis();
            if (document.getElementById("input_init_e_is_on").checked) draw_field_arrows_and_name();
            draw_init_state();
            redraw_all_objects();
            window.requestAnimationFrame(redraw_window_function);
        }

        function reset_to_defaults() {
            if (document.getElementById("button_pause").innerText === "Пауза: ON") {
                change_pause_state();
            }

            document.getElementById("input_init_x").value = canvas.width / 4;
            document.getElementById("input_init_y").value = canvas.height / 2;
            document.getElementById("input_init_velocity").value = 1;
            document.getElementById("input_init_x_dir").value = 1;
            document.getElementById("input_init_y_dir").value = 0;
            document.getElementById("input_init_e_field").value = 0;
            document.getElementById("input_init_e_field_dir").checked = true;
            document.getElementById("input_time_multiplier").value = 1;
            document.getElementById("input_init_q").value = 0;
            document.getElementById("input_init_m").value = 1;
            document.getElementById("input_init_e_is_on").checked = true;
        }

        let auto_handler;
        function auto_shoot() {
            let btn = document.getElementById("button_auto_shoot");
            if (btn.innerText === "Auto shoot: OFF") {
                document.getElementById("button_auto_shoot").innerText = "Auto shoot: ON";
                auto_handler = setInterval(function () {
                    create_particle();
                }, 1000);
            } else {
                clearInterval(auto_handler);
                document.getElementById("button_auto_shoot").innerText = "Auto shoot: OFF";
            }
        }

        function remove_all_objects() {
            array_of_objects = [];
            selected_element = -1;
        }

        let prev_state_auto_shoot_is_on = false;
        let prev_time_multiplier = 0;
        function change_pause_state() {
            let btn = document.getElementById("button_pause");
            if (btn.innerText === "Пауза: OFF") {
                document.getElementById("button_pause").innerText = "Пауза: OFF";
                if (document.getElementById("button_auto_shoot").innerText === "Auto shoot: OFF") {
                    prev_state_auto_shoot_is_on = false;
                } else {
                    prev_state_auto_shoot_is_on = true;
                    auto_shoot();
                }

                document.getElementById("button_auto_shoot").disabled = true;
                document.getElementById("button_create_particle").disabled = true;
                prev_time_multiplier = parseInt(document.getElementById("input_time_multiplier").value);
                document.getElementById("input_time_multiplier").value = 0;
                document.getElementById("input_time_multiplier").disabled = true;
                btn.innerText = "Пауза: ON";
            } else {
                document.getElementById("button_auto_shoot").disabled = false;
                document.getElementById("button_create_particle").disabled = false;
                document.getElementById("input_time_multiplier").value = prev_time_multiplier;
                document.getElementById("input_time_multiplier").disabled = false;
                if (prev_state_auto_shoot_is_on) {
                    auto_shoot();
                    prev_state_auto_shoot_is_on = false;
                }
                btn.innerText = "Пауза: OFF";
            }
        }

    </script>
</head>

<body onload="init()">
    <h1>
        Задача на моделирование №2. Электростатика
    </h1>
    <h2>
        Движение заряженных частиц в электростатическом поле
    </h2>
    <h2>
        M3101. Дудко Матвей
    </h2>
    <table>
        <tr>
            <td>
                <canvas height='600' width='800' id='canvas_id'>Обновите браузер</canvas>
            </td>
            <td align="left" valign="top">
                <span style="color: black; font-family: Times New Roman,serif; font-size: 12pt">
                <table>
                    <tr><b><u>Данные выбранной точки:</u></b></tr>
                    <tr>
                        <td>
                            X:
                        </td>
                        <td>
                            <output id="output_x">
                                [X]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Y:
                        </td>
                        <td>
                            <output id="output_y">
                                [Y]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Модуль Скорости:
                        </td>
                        <td>
                            <output id="output_v">
                                [V]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Модуль Ускорения:
                        </td>
                        <td>
                            <output id="output_a">
                                [A]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Q:
                        </td>
                        <td>
                            <output id="output_q">
                                [Q]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Масса:
                        </td>
                        <td>
                            <output id="output_m">
                                [M]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Модуль Силы:
                        </td>
                        <td>
                            <output id="output_f">
                                [F]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                        <br>
                            <b><u>
                                Проекции:
                            </u></b>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Скорость<sub>X</sub>:
                        </td>
                        <td>
                            <output id="output_v_x">
                                [V<sub>X</sub>]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Скорость<sub>Y</sub>:
                        </td>
                        <td>
                            <output id="output_v_y">
                                [V<sub>Y</sub>]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Ускорение<sub>X</sub>:
                        </td>
                        <td>
                            <output id="output_a_x">
                                [A<sub>X</sub>]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Ускорение<sub>Y</sub>:
                        </td>
                        <td>
                            <output id="output_a_y">
                                [A<sub>Y</sub>]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Сила<sub>X</sub>:
                        </td>
                        <td>
                            <output id="output_f_x">
                                [F<sub>X</sub>]
                            </output>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Сила<sub>Y</sub>:
                        </td>
                        <td>
                            <output id="output_f_y">
                                [F<sub>Y</sub>]
                            </output>
                        </td>
                    </tr>
                </table>
                </span>
            </td>
        </tr>
    </table>
    <button onclick="create_particle()" id="button_create_particle">Добавить объект</button>
    <button onclick="auto_shoot()" id="button_auto_shoot">Auto shoot: OFF</button>
    <button onclick="remove_all_objects()">Очистить всё</button>
    <button onclick="change_pause_state()" id="button_pause">Пауза: OFF</button>
    <!-- ToDO: debug -->
    <!-- <button onclick="create_particle_and_animate_console(4, 1, -0.2)">Test</button> -->
    <br>

    <table style="margin-top: 5px">
        <tr>
            <td>
                <label for="input_init_x" id="input_init_x_label">
                    Начальная координата X:
                </label>
            </td>
            <td>
                <!-- Set maximum is in init() -->
                <input type="number" id="input_init_x" min="0">
            </td>
        </tr>
        <tr>
            <td>
                <!-- Set maximum is in init() -->
                <label for="input_init_y" id="input_init_y_label">
                    Начальная координата Y:
                </label>
            </td>
            <td>
                <input type="number" id="input_init_y" min="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_q">
                    Коэффициент заряда q: [any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_q" value="0" step="0.1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_m">
                    Коэффициент массы m: [0.001 .. any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_m" value="1" min="0.001">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_velocity">
                    Начальная скорость V<sub>0</sub>: [0 .. any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_velocity" min="0" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_x_dir">
                    Координата X вектора направления скорости: [any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_x_dir" value="1">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_y_dir">
                    Координата Y вектора направления скорости: [any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_y_dir" value="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_e_field">
                    Напряженность поля: [0 .. any]
                </label>
            </td>
            <td>
                <input type="number" id="input_init_e_field" min="0" max="100" value="0">
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_e_field_dir">
                    Поле направлено вниз?
                </label>
            </td>
            <td>
                <input type="checkbox" id="input_init_e_field_dir" checked>
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_init_e_is_on">
                    Поле включено?
                </label>
            </td>
            <td>
                <input type="checkbox" id="input_init_e_is_on" checked>
            </td>
        </tr>
        <tr>
            <td>
                <label for="input_time_multiplier">
                    Коэффициент ускорения времени: [any, в том числе и отрицательный]
                </label>
            </td>
            <td>
                <input type="number" id="input_time_multiplier" min="0" max="5" step="0.25" value="1">
            </td>
        </tr>


        <!-- ToDO: -->
        <!--
        <tr>
            <td>
                <label for="input_gravity_field_is_on">
                    <del>Учитывать гравитацию? [ToDO]</del>
                </label>
            </td>
            <td>
                <input type="checkbox" id="input_gravity_field_is_on" readonly disabled>
            </td>
        </tr>

        -->


        <tr>
            <td>
                <button onclick="reset_to_defaults()">Сбросить</button>
            </td>
        </tr>
    </table>

</body>
</html>

<!-- ToDO:
- Сделать корректные размерности

-- Нужно??
- Сила тяжести???


-- Как бы написано, но не проверяется при вводе данных
- Явным образом написать ограничения для входных данных
- Сделать нормальное ограничение

-- Дополнительно можно сделать:
--- Не будет реализовано в версии 1
- Время: зависит от количества fps на экране
- Мышь
- Менять направление вектора E поля + размеры
- Красивые кнопки и поля
-->
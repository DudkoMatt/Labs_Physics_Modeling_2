<!-- 2.	Движение заряженных частиц в электростатическом поле -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Моделирование №2</title>
    <meta charset='utf-8' />

    <style>
        canvas {
            border-style: solid;
        }
    </style>

    <script src="Particle.js"></script>
    <script type="text/javascript">
        let canvas, ctx;
        let raf_id;

        // Note: ось y направлена вниз в canvas
        let init_coordinate_x, init_coordinate_y;
        const SPACER = 20;

        let array_of_objects = [];

        function init() {
            // Инициализация canvas
            canvas = document.getElementById("canvas_id");
            ctx    = canvas.getContext('2d');
            init_coordinate_x = SPACER;
            init_coordinate_y = canvas.height - SPACER;
            raf_id = window.requestAnimationFrame(redraw_window_function);
        }

        // function draw_axis() {
        //     // Отрисовка прямых линий
        //     ctx.beginPath();
        //     ctx.moveTo(init_coordinate_x, init_coordinate_y);
        //     ctx.lineTo(canvas.width - SPACER, init_coordinate_y);
        //     ctx.moveTo(init_coordinate_x, init_coordinate_y);
        //     ctx.lineTo(init_coordinate_x, SPACER);
        //     ctx.stroke();
        // }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        function delete_particle_from_array(idx) {
            array_of_objects = array_of_objects.filter(function (value, index, arr) {
                return value.IDX !== idx;
            });
        }

        function clear_all() {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }

        // Считаем, что поле начинается с середины экрана (с середины ширины)
        function draw_area_electric_field() {
            ctx.save();
            ctx.fillStyle = "rgba(125,255,125,0.5)";
            ctx.fillRect(canvas.width / 2, 0, canvas.width / 2, canvas.height);
            ctx.restore();
        }

        function redraw_all_objects() {
            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].draw();
            }
        }

        // function add_new_object() {
        //     array_of_objects.push(new Particle(getRandomInt(canvas.width), getRandomInt(canvas.height)));
        //     redraw_window_function();
        // }


        // ToDO: поле направлено вертикально
        function create_particle_and_animate(vel = 1, x_dir = 1, y_dir = 1) {
            // Переменная для ограничения максимально возможного рендеринга
            let t = 0;
            let p = new Particle(1, 2, vel, 4);
            p.Velocity_Vector = (new Vector(x_dir, y_dir)).normalize();
            array_of_objects.push(p);

            // function next_step() {
            //     if (t < 10000 && p.in_view()) {
            //         // ToDO: delete debug
            //         console.log(t + ": " + p.in_view());
            //         p.calc_new_pos_without_acceleration(1);
            //         t++;
            //     } else {
            //         // ToDO: delete debug
            //         console.log(t + ": " + p.in_view());
            //         delete_particle_from_array(p.IDX);
            //     }
            // }

        }
        
        function calculate_all_next_step() {
            // ToDO:
            let time = 1;

            for (let i = 0; i < array_of_objects.length; i++) {
                array_of_objects[i].next_step(time);
            }

            let items_to_delete = [];
            for (let i = 0; i < array_of_objects.length; i++) {
                if (!array_of_objects[i].in_view())
                    items_to_delete.push(array_of_objects[i].IDX);
            }

            for (let i = 0; i < items_to_delete.length; i++) {
                delete_particle_from_array(items_to_delete[i]);
            }
        }
        
        function redraw_window_function() {
            calculate_all_next_step();
            clear_all();
            draw_area_electric_field();
            redraw_all_objects();
            window.requestAnimationFrame(redraw_window_function);
        }

    </script>
</head>

<body onload="init()">
    <canvas height='800' width='800' id='canvas_id'>Обновите браузер</canvas>
    <br>
    <!-- <button onclick="draw_circle(getRandomInt(canvas.width), getRandomInt(canvas.height))">Нарисовать рандомный круг</button>
    <button onclick="clear_all()">Очистить</button> -->
    <button onclick="create_particle_and_animate()">Добавить объект</button>
    <!-- <button onclick="redraw_all_objects()">Отрисовать</button> -->
</body>
</html>
